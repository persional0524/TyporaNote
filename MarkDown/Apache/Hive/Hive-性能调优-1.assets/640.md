

# HDFS的读写流程以及多线程写问题

1. **HDFS之block、package、chunk**

- block

  文件上传需要分块，这个块就是block，一般128MB，可以改，但是不建议。

  因为块太小：寻址时间占比过高。快太大：Map任务数太少，作业执行速度慢，他是一个大单位。

- package

  package是第二大的单位，他是client端向DataNode,或DataNode的==Pipline==之间传==数据的基本单位==，默认64KB.

- chunk

  chunk是最小单位，他是client端向DataNode,或DataNode的==Pipline==之间==进行数据校验的基本单位==，默认512Byte，因为用作校验，故每个==chunk需要带有4Byte的校验位。所以实际每个chunk写入packet的大小为516Byte==

  

1. **HDFS的写流程**

2. **HDFS的读流程**

3. **HDFS写数据过程中Datanode出错**

4. **HDFS是否多线程写**

   否。

   

Hive作为大数据平台举足轻重的框架，以其稳定性和简单易用性也成为当前构建企业级数据仓库时使用最多的框架之一。

但是如果我们只局限于会使用Hive，而不考虑性能问题，就难搭建出一个完美的数仓，所以Hive性能调优是我们大数据从业者必须掌握的技能。本文将给大家讲解Hive性能调优的一些方法及技巧。

## Hive性能问题排查方式

当我们发现一条SQL语句执行时间过长或者不合理时，我们就要考虑对SQL进行优化，优化首先得进行问题排查，那么我们可以通过哪些方式进行排查呢。

经常使用关系型数据库的同学可能知道关系型数据库的优化的诀窍-**看执行计划**。如Oracle数据库，它有多种类型的执行计划，通过多种执行计划的配合使用，可以看到根据统计信息推演的执行计划，即Oracle推断出来的未真正运行的执行计划；能够观察到从数据读取到最终呈现的主要过程和中间的量化数据。可以说，在Oracle开发领域，掌握合适的环节，选用不同的执行计划，SQL调优就不是一件难事。

Hive中也有执行计划，但是Hive的执行计划都是预测的，这点不像Oracle和SQL Server有真实的计划，可以看到每个阶段的处理数据、消耗的资源和处理的时间等量化数据。Hive提供的执行计划没有这些数据，这意味着虽然Hive的使用者知道整个SQL的执行逻辑，但是各阶段耗用的资源状况和整个SQL的执行瓶颈在哪里是不清楚的。

想要知道HiveSQL所有阶段的运行信息，可以查看**YARN提供的日志**。查看日志的链接，可以在每个作业执行后，在控制台打印的信息中找到。如下图所示：

![图片](Hive-性能调优-1.assets/640)

**Hive提供的执行计划目前可以查看的信息有以下几种**：

1. 查看执行计划的基本信息，即explain；
2. 查看执行计划的扩展信息，即explain extended；
3. 查看SQL数据输入依赖的信息，即explain dependency；
4. 查看SQL操作相关权限的信息，即explain authorization；
5. 查看SQL的向量化描述信息，即explain vectorization。

在查询语句的SQL前面加上关键字explain是查看执行计划的基本方法。用explain打开的执行计划包含以下两部分：

- 作业的依赖关系图，即STAGE DEPENDENCIES；
- 每个作业的详细信息，即STAGE PLANS。

**Hive中的explain执行计划详解可看我之前写的这篇文章**：[Hive底层原理：explain执行计划详解]

> 注：使用explain查看执行计划是Hive性能调优中非常重要的一种方式，请务必掌握！

**总结：Hive对SQL语句性能问题排查的方式**：

1. 使用explain查看执行计划；
2. 查看YARN提供的日志。

## Hive性能调优的方式

为什么都说性能优化这项工作是比较难的，因为一项技术的优化，必然是一项综合性的工作，它是多门技术的结合。我们如果只局限于一种技术，那么肯定做不好优化的。

下面将从多个完全不同的角度来介绍Hive优化的多样性，我们先来一起感受下。

### 1. SQL语句优化

SQL语句优化涉及到的内容太多，因篇幅有限，不能一一介绍到，所以就拿几个典型举例，让大家学到这种思想，以后遇到类似调优问题可以往这几个方面多思考下。

Hive作为大数据平台举足轻重的框架，以其稳定性和简单易用性也成为当前构建企业级数据仓库时使用最多的框架之一。

但是如果我们只局限于会使用Hive，而不考虑性能问题，就难搭建出一个完美的数仓，所以Hive性能调优是我们大数据从业者必须掌握的技能。本文将给大家讲解Hive性能调优的一些方法及技巧。

## Hive性能问题排查方式

当我们发现一条SQL语句执行时间过长或者不合理时，我们就要考虑对SQL进行优化，优化首先得进行问题排查，那么我们可以通过哪些方式进行排查呢。

经常使用关系型数据库的同学可能知道关系型数据库的优化的诀窍-**看执行计划**。如Oracle数据库，它有多种类型的执行计划，通过多种执行计划的配合使用，可以看到根据统计信息推演的执行计划，即Oracle推断出来的未真正运行的执行计划；能够观察到从数据读取到最终呈现的主要过程和中间的量化数据。可以说，在Oracle开发领域，掌握合适的环节，选用不同的执行计划，SQL调优就不是一件难事。

Hive中也有执行计划，但是Hive的执行计划都是预测的，这点不像Oracle和SQL Server有真实的计划，可以看到每个阶段的处理数据、消耗的资源和处理的时间等量化数据。Hive提供的执行计划没有这些数据，这意味着虽然Hive的使用者知道整个SQL的执行逻辑，但是各阶段耗用的资源状况和整个SQL的执行瓶颈在哪里是不清楚的。

想要知道HiveSQL所有阶段的运行信息，可以查看**YARN提供的日志**。查看日志的链接，可以在每个作业执行后，在控制台打印的信息中找到。如下图所示：

![图片](Hive-性能调优-1.assets/640-20210427092436316)

**Hive提供的执行计划目前可以查看的信息有以下几种**：

1. 查看执行计划的基本信息，即explain；
2. 查看执行计划的扩展信息，即explain extended；
3. 查看SQL数据输入依赖的信息，即explain dependency；
4. 查看SQL操作相关权限的信息，即explain authorization；
5. 查看SQL的向量化描述信息，即explain vectorization。

在查询语句的SQL前面加上关键字explain是查看执行计划的基本方法。用explain打开的执行计划包含以下两部分：

- 作业的依赖关系图，即STAGE DEPENDENCIES；
- 每个作业的详细信息，即STAGE PLANS。

**Hive中的explain执行计划详解可看我之前写的这篇文章**：[Hive底层原理：explain执行计划详解](https://mp.weixin.qq.com/s?__biz=Mzg2MzU2MDYzOA==&mid=2247484152&idx=1&sn=7e48aa4a9650481f960c6cac234977a4&scene=21#wechat_redirect)

> 注：使用explain查看执行计划是Hive性能调优中非常重要的一种方式，请务必掌握！

**总结：Hive对SQL语句性能问题排查的方式**：

1. 使用explain查看执行计划；
2. 查看YARN提供的日志。

## Hive性能调优的方式

为什么都说性能优化这项工作是比较难的，因为一项技术的优化，必然是一项综合性的工作，它是多门技术的结合。我们如果只局限于一种技术，那么肯定做不好优化的。

下面将从多个完全不同的角度来介绍Hive优化的多样性，我们先来一起感受下。

### 1. SQL语句优化

SQL语句优化涉及到的内容太多，因篇幅有限，不能一一介绍到，所以就拿几个典型举例，让大家学到这种思想，以后遇到类似调优问题可以往这几个方面多思考下。